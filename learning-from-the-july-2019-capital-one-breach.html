<!doctype html><html lang="en"><head><meta name="google-site-verification" content="iwCg_a-vVgFpfSWBajnl_3T97hetrL_jHS3nVkinaho"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="InfoSec Zanshin, Thoughts on information security, entrepreneurship and more."><link rel="alternate" href="https://www.infoseczanshin.com/feeds/all.atom.xml" type="application/atom+xml" title="InfoSec Zanshin Full Atom Feed"><title>Learning from the July 2019 Capital One Breach // InfoSec Zanshin // Thoughts on information security, entrepreneurship and more.</title><link rel="apple-touch-icon" sizes="57x57" href="/images/favicon/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/images/favicon/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="manifest" href="/images/favicon/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="https://www.infoseczanshin.com/theme/css/pure.css"><link rel="stylesheet" href="https://www.infoseczanshin.com/theme/css/pygments.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fitvids/1.2.0/jquery.fitvids.min.js"></script><script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script></head><body><div class="pure-g-r" id="layout"><div class="sidebar pure-u"><div class="cover-img" style="background-image: url('/images/cloud_background.png')"><div class="cover-body"><header class="header"><div><img class="avatar" src="/images/zanshin.png"><h1 class="brand-main"><a href="https://www.infoseczanshin.com">InfoSec Zanshin</a></h1><p class="tagline">Thoughts on information security, entrepreneurship and more.</p><p class="social"><a href="feeds/all.atom.xml" target="_blank"><i class="fa fa-rss-square fa-2x"></i></a><a href="https://br.linkedin.com/in/sieira" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a><a href="https://twitter.com/AlexandreSieira" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a><a href="https://github.com/asieira/" target="_blank"><i class="fa fa-github-square fa-2x"></i></a></p></div></header></div></div></div><div class="pure-u"><div class="content"><section class="post"><header class="post-header"><h1>Learning from the July 2019 Capital One Breach</h1><p class="post-meta"> // under <a class="post-category" href="https://www.infoseczanshin.com/tag/aws.html">aws</a><a class="post-category" href="https://www.infoseczanshin.com/tag/cloud.html">cloud</a><a class="post-category" href="https://www.infoseczanshin.com/tag/breach.html">breach</a></p><p class="post-meta"> // Tue 30 July 2019 </p></header></section><p>News broke today of <a href="https://www.washingtonpost.com/national-security/capital-one-data-breach-compromises-tens-of-millions-of-credit-card-applications-fbi-says/2019/07/29/72114cc2-b243-11e9-8f6c-7828e68cb15f_story.html?utm_term=.f5b3ccbc7616">breach involving Capital One</a>, involving the theft of data stored in non-public S3 buckets through a multi-step targeted attack. </p><p>The first thing I want to make clear is that I sympathize with the Capital One security and operations teams at this difficult time. Capital One is a well-known innovator in cloud security, has very competent people dedicated to this and has even developed and high quality open source solutions such as <a href="https://cloudcustodian.io/">Cloud Custodian</a> that benefit the entire community. No security is perfect, and if you are a big enough target get used to the idea that being breached is a question of "when" not "if".</p><p>I sincerely hope that this incident is not blown out of proportion and does not cause a slow down of their strategy of being a cloud-first bank by next year, as they announced on stage at <a href="https://www.infoseczanshin.com/highlights-from-aws-reinforce-2019.html">AWS re:Inforce</a>. In any case, I think that an organization as heavily invested into cloud security as Capital One being breached is a good reminder that security is hard. Also, that even though the cloud offers many advantages in applying security over on-premises environments, it is still relatively new and evolving technology and there's a non-trivial learning curve.</p><p>You can see the <a href="#resources">Resources</a> section below for detailed write-ups, and the <a href="https://regmedia.co.uk/2019/07/29/capital_one_paige_thompson.pdf">affidavit</a> describing what is known so far about this case. Reading through this and discussing this with others, I'd like to document a few practical guidelines and mitigations that might help prevent similar attacks in the future.</p><h2>Least Privilege</h2><p>The attack involved the attacker obtaining temporary credentials associated with an IAM role referenced as <code>*****-WAF-Role</code> in the <a href="https://regmedia.co.uk/2019/07/29/capital_one_paige_thompson.pdf">affidavit</a>. A big part of the problem seems to be that this role had excessive privileges: </p><blockquote class="twitter-tweet"><p dir="ltr">For service roles, remove s3:ListAllMyBuckets and similar List/Describe privs. Code normally knows what buckets it needs to work with, and does not need to list them.</p>&mdash; Scott Piper (@0xdabbad00) <a href="https://twitter.com/0xdabbad00/status/1156011925542584320?ref_src=twsrc%5Etfw">July 30, 2019</a></blockquote><p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p><p>Being able to use the unnecessary <a href="https://docs.aws.amazon.com/AmazonS3/latest/API/RESTServiceGET.html">list buckets</a> privilege granted to the role allowed the attacker to find out and explore multiple buckets until they found interesting data. Had that privilege not been granted to the role, and assuming they didn't have insider knowledge of the infrastructure, the attacker might have been slowed down or even prevented from finding buckets with sensitive data entirely.</p><p>The same IAM role credentials were then used to list and download data from the buckets apparently using the AWS CLI <a href="https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html"><code>s3 sync</code></a> command, which actually uses multiple bucket list and object read operations to do its work.</p><p>The name indicates that this role was being used by a Web Application Firewall solution. So presumably the S3 privileges were either meant to allow it to access websites published via S3 or to write logs or configuration backups to S3. It wouldn't surprise me if someone simply granted access to all buckets or even to all S3 operations during deployment either manually or using an <a href="https://www.tripwire.com/state-of-security/security-data-protection/cloud/aws-system-manager-default-permissions/">overly permissive AWS Managed Policy</a> in the same role.</p><p>So two lessons here:</p><ul><li><p><strong>Ensure your policies allow as few Actions and Resources as possible!</strong> Avoid using <code>*</code> like the plague, and always provide an explicit list of Actions and Resources in your policies.</p></li><li><p>Don't trust AWS Managed Policies blindly. Review them and, when necessary, create more specific and more secure versions for your own use. Particularly when they violate the first lesson.</p></li></ul><p>If the WAF role in this incident only had access to writing new objects into a single bucket containing WAF logs, the impact from this intrusion might have been minimized.</p><h2>Control Permission Use Context with Policy Conditions</h2><p>The other thing that caught my attention on this breach is that the attacker was able to get <a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html">temporary credentials from an IAM role</a> assigned to a resource on Capital One's VPC and then use them from an external computer under their control to download data from the S3 buckets. </p><p>On an on-premises environment, a "private" FTP or NFS server would be on an internal network not accessible from the Internet, so the attacker would not only need credentials but also network access in order to use them. That's not how S3 works, however. Even non-public S3 buckets can be accessed by default from anywhere in the world by someone holding the right credentials. </p><p>Turns out, though, that you can implement something similar in the case of S3 buckets. A very infrequently used security measure for S3 buckets is to limit the access to API requests originated on a specific VPC, <a href="https://docs.aws.amazon.com/vpc/latest/userguide/vpc-endpoints-s3.html">VPC endpoint</a> of IP address ranges by using <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/amazon-s3-policy-keys.html">policy conditions</a>.</p><p>So at a minimum, if you have an IAM role granting access to a particular S3 bucket, and that role is only meant to be used by on-VPC resources such as EC2 instances, you could make it so that the access is only granted if the VPC or VPC endpoint is the one you expect.</p><p>Even better, if a particular bucket will only be used by resources on your VPC, you could add a <a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies-vpc-endpoint.html">statement to the bucket policy denying any access attempt that does not originate from the specific VPC or VPC endpoints you control</a> to its bucket policy. This would ensure that even if excessive privileges are granted to users or roles, the Deny statement will take precedence and no access to that bucket from outside of your VPC will ever happen. This would be the closest equivalent to the "FTP or NFS server in the internal network" analogy on an on-premises environment.</p><p>Either of those measures might have prevented the attacker from using the role's temporary credentials to access those non-public buckets from a computer outside of the company VPC to download the data. The attacker would have then needed to take additional steps, such as compromising or creating a new resource on the Capital One VPC with sufficient outbound network permissions, in order to exfiltrate the data. This might have created the conditions that allowed the intrusion to be detected before it was successful.</p><p>This technique can be generalized to other services beyond S3, of course, but make sure you test the necessary scenarios thoroughly to avoid blocking legitimate requests. Not all condition keys are available in all API access scenarios and service combinations, because why would things be this easy?</p><h2 id="resources">Resources</h2><p>Here are a few other resources if you want to learn more about what the incident:</p><ul><li><p><a href="https://www.theregister.co.uk/2019/07/30/capital_one_hacked/">Capital One gets Capital Done: Hacker swipes personal info on 106 million US, Canadian credit card applicants</a> by The Register using a rather distasteful title but with good information. </p></li><li><p><a href="https://regmedia.co.uk/2019/07/29/capital_one_paige_thompson.pdf">Affidavit</a> which is the original source of what is known so far about the breach, including the alledged attacker's many OPSEC failings.</p></li><li><p><a href="https://securosis.com/blog/what-we-know-about-the-capital-one-data-breach">What We Know about the Capital One Data Breach</a> by <a href="https://twitter.com/rmogull">Rich Mogull</a></p></li><li><p><a href="https://medium.com/netflix-techblog/netflix-information-security-preventing-credential-compromise-in-aws-41b112c15179">Netflix Information Security: Preventing Credential Compromise in AWS</a> by the Netflix team and brought to my attention by <a href="https://twitter.com/0xdabbad00">Scott Piper</a></p></li></ul><a href="#" class="go-top">Go Top</a><div class="comments"><div id="disqus_thread"></div><script>
         /**
          * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
          * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
         */
         var disqus_config = function () {
           this.page.url = "https://www.infoseczanshin.com/learning-from-the-july-2019-capital-one-breach.html"; // Replace PAGE_URL with your page's canonical URL variable
           this.page.identifier = "Learning from the July 2019 Capital One Breach"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
         };
         (function() { // DON'T EDIT BELOW THIS LINE
           var d = document, s = d.createElement('script');

           s.src = 'https://infoseczanshin.disqus.com/embed.js';

           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
         })();
       </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><footer class="footer"><p>&copy; Alexandre Sieira &ndash; Built with a <a href="https://github.com/asieira/pure-single">modified version of Pure Theme</a> for <a href="http://blog.getpelican.com/">Pelican</a></p></footer></div></div><script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73747222-1', 'auto');
  ga('send', 'pageview');

</script></body><script src="js/redirect.js"></script></html>